<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
</head>
<body>
    <h1>회원가입</h1>

    <label for="userid">ID</label><input id="userid" type="text" required>
    <button id="btnCheck" type="button">중복확인</button><br>
    <div id="useridStatus"></div>

    <label for="password">Password</label><input id="password" type="password" required minlength="4"><br>
    <label for="passwordCheck">Password 확인</label><input id="passwordCheck" type="password" required minlength="4"><br>
    <div id="passwordError" style="color:red;"></div> <!-- 비밀번호 오류 메시지 -->

    <label for="email">Email</label><input id="email" type="email" required><br>
    <div id="emailError" style="color:red;"></div> <!-- 이메일 오류 메시지 -->

    <label for="gender">성별</label>
    <select id="gender" required>
        <option value="">선택하세요</option>
        <option value="male">남성</option>
        <option value="female">여성</option>
    </select><br>
    
    <!-- 생년월일 선택 -->
    <label for="year">년</label>
    <select id="year" required>
        <option value="">연도 선택</option>
        <script>
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1900; year--) {
                document.write(`<option value="${year}">${year}</option>`);
            }
        </script>
    </select>

    <label for="month">월</label>
    <select id="month" required>
        <option value="">월 선택</option>
        <script>
            for (let month = 1; month <= 12; month++) {
                document.write(`<option value="${month}">${month}</option>`);
            }
        </script>
    </select>

    <label for="day">일</label>
    <select id="day" required>
        <option value="">일 선택</option>
        <script>
            for (let day = 1; day <= 31; day++) {
                document.write(`<option value="${day}">${day}</option>`);
            }
        </script>
    </select><br>

    <label for="userName">Name</label><input id="userName" type="text" required><br>
    <button id="btnJoin" type="button">Join</button>

<script>
(() => {
    const $userid = document.querySelector('#userid');
    const $password = document.querySelector('#password');
    const $passwordCheck = document.querySelector('#passwordCheck');
    const $email = document.querySelector('#email');
    const $gender = document.querySelector('#gender');
    const $year = document.querySelector('#year');
    const $month = document.querySelector('#month');
    const $day = document.querySelector('#day');
    const $userName = document.querySelector('#userName');
    const $btnCheck = document.querySelector("#btnCheck");
    const $useridStatus = document.querySelector('#useridStatus');
    const $btnJoin = document.querySelector('#btnJoin');
    const $passwordError = document.querySelector('#passwordError');
    const $emailError = document.querySelector('#emailError');

    const verifyData = function() {
        let valid = true;
        $passwordError.textContent = ''; // 초기화
        $emailError.textContent = ''; // 초기화

        // 비밀번호 확인
        if ($password.value !== $passwordCheck.value) {
            $passwordError.textContent = '비밀번호가 일치하지 않습니다.';
            valid = false;
        }

        // 이메일 형식 검사
        const emailRegex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
        if (!emailRegex.test($email.value)) {
            alert('유효하지 않은 이메일 형식입니다. 회원가입이 불가능합니다.');
            valid = false;
        }

        return valid;
    };

    // 비밀번호 확인 시 실시간 체크
    $passwordCheck.addEventListener('input', () => {
        if ($password.value !== $passwordCheck.value) {
            $passwordError.textContent = '비밀번호가 일치하지 않습니다.';
        } else {
            $passwordError.textContent = ''; // 일치하는 경우 오류 메시지 초기화
        }
    });

    $btnCheck.addEventListener('click', () => {
        const userid = $userid.value;

        if(userid.length === 0) {
            alert("ID를 입력해 주세요.");
            return;
        }

        fetch(`/user/check-userid?userid=${encodeURIComponent(userid)}`)
        .then(response => response.json())
        .then(isAvailable => {
            if(isAvailable) {
                alert('사용가능한 ID입니다.'); 
                $btnJoin.disabled = false;
            } else {
                alert('이미 사용 중인 ID 입니다.');
                $btnJoin.disabled = true; 
            }
        })
        .catch(error => {
            console.error("중복 확인 중 오류 발생:", error);
        });
    });

    document.querySelector('#btnJoin').addEventListener('click', () => {
        // 비밀번호와 이메일 유효성 검사
        if (verifyData()) {
            const regObj = {        
                userid: $userid.value,
                password: $password.value,
                passwordCheck: $passwordCheck.value,
                email: $email.value,
                gender: $gender.value,
                birthDate: `${$year.value}-${$month.value.padStart(2, '0')}-${$day.value.padStart(2, '0')}`,
                userName: $userName.value
            };

            fetch('/user/join', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(regObj)
            })
            .then(response => response.text())
            .then(message => alert(message))
            .catch(error => console.error('회원가입 중 오류 발생:', error));
        }
    });
})();
</script>
</body>
</html>
